define([], function() {

    const state = {
        dirty: false
    };

    function moveElement(el, direction) {
        if (el.classList.contains('area-card') && isVirtualArea(el)) {
            return;
        }
        const sibling = direction === 'up'
            ? el.previousElementSibling
            : el.nextElementSibling;

        if (!sibling) {
            return;
        }

        if (
            el.classList.contains('area-card') &&
            direction === 'down' &&
            isVirtualArea(sibling)
        ) {
            return;
        }
        const parent = el.parentElement;

        if (direction === 'up') {
            parent.insertBefore(el, sibling);
        } else {
            parent.insertBefore(sibling, el);
        }

        state.dirty = true;
        updateControls();
    }

    function bindAreaControls() {
        document.querySelectorAll('.move-area-up').forEach(btn => {
            btn.addEventListener('click', e => {
                const area = e.target.closest('.area-card');
                moveElement(area, 'up');
            });
        });

        document.querySelectorAll('.move-area-down').forEach(btn => {
            btn.addEventListener('click', e => {
                const area = e.target.closest('.area-card');
                moveElement(area, 'down');
            });
        });
    }

    function bindSubjectControls() {
        document.querySelectorAll('.move-subject-up').forEach(btn => {
            btn.addEventListener('click', e => {
                const subject = e.target.closest('.subject-item');
                moveElement(subject, 'up');
            });
        });

        document.querySelectorAll('.move-subject-down').forEach(btn => {
            btn.addEventListener('click', e => {
                const subject = e.target.closest('.subject-item');
                moveElement(subject, 'down');
            });
        });
    }

    function collectStructure() {
        const areas = [];

        document.querySelectorAll('.area-card').forEach((areaEl, areaIndex) => {
            const areaid = areaEl.dataset.areaid || null;
            const subjects = [];

            areaEl.querySelectorAll('.subject-item').forEach((subEl, subIndex) => {
                subjects.push({
                    id: subEl.dataset.subjectid,
                    sortorder: subIndex
                });
            });

            areas.push({
                id: areaid,
                sortorder: areaIndex,
                subjects: subjects
            });
        });

        return areas;
    }

    function bindSave(planid) {
        const btn = document.getElementById('save-structure');
        if (!btn) {
            return;
        }

        btn.addEventListener('click', () => {
            const structure = collectStructure();

            // Aquí llamarás a tu webservice / ajax
            console.log('STRUCTURE TO SAVE', structure);

            state.dirty = false;
        });
    }
    function isVirtualArea(areaEl) {
        return areaEl.dataset.virtual === '1'
    }
    function updateControls() {

        const areas = Array.from(document.querySelectorAll('.area-card'))
            .filter(a => !isVirtualArea(a));

        areas.forEach((area, index) => {
            const up = area.querySelector('.move-area-up');
            const down = area.querySelector('.move-area-down');

            if (up) {
                up.disabled = index === 0;
            }

            if (down) {
                down.disabled = index === areas.length - 1;
            }
        });

        document.querySelectorAll('.subjects').forEach(list => {
            const items = list.querySelectorAll('.subject-item');

            items.forEach((item, index) => {
                const up = item.querySelector('.move-subject-up');
                const down = item.querySelector('.move-subject-down');

                if (up) {
                    up.disabled = index === 0;
                }

                if (down) {
                    down.disabled = index === items.length - 1;
                }
            });
        });
    }

    return {
        init: function(config) {
            if (config.readonly) {
                return;
            }

            bindAreaControls();
            bindSubjectControls();
            bindSave(config.planid);
            updateControls();
        }
    };
});