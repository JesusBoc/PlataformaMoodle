define([
    'core/sortable_list',
    'core/ajax',
    'core/toast'
], function(SortableList, Ajax, Toast) {

    let state = {
        planid: null,
        readonly: false,
        dirty: false
    };

    const init = function(config) {
        state.planid = config.planid;
        state.readonly = !!config.readonly;

        if (state.readonly) {
            return;
        }

        initAreaSorting();
        initSubjectSorting();
        initSaveButton();
    };

    /* =======================
     * Areas sorting
     * ======================= */

    function initAreaSorting() {
    const container = document.querySelector('.areas-container');
    if (!container) {
        return;
    }

    new SortableList(container, {
        items: '.area-card',
        handle: '.area-drag-handle'
    });

    container.addEventListener('sortupdate', markDirty);
}

function initSubjectSorting() {
    document.querySelectorAll('.subjects').forEach(list => {

        new SortableList(list, {
            items: '.subject-item',
            handle: '.subject-drag-handle'
        });

        list.addEventListener('sortupdate', markDirty);
    });
}

    /* =======================
     * Save
     * ======================= */

    function initSaveButton() {
        const button = document.getElementById('save-structure');
        if (!button) {
            return;
        }

        button.addEventListener('click', function() {
            if (!state.dirty) {
                return;
            }

            saveStructure();
        });
    }

    function saveStructure() {
        const payload = buildPayload();

        Ajax.call([{
            methodname: 'local_curriculum_save_plan_structure',
            args: payload
        }])[0].then(function() {
            state.dirty = false;
            Toast.add('Estructura guardada', {type: Toast.TYPE.SUCCESS});
        }).catch(function(err) {
            console.error(err);
            Toast.add('Error al guardar', {type: Toast.TYPE.ERROR});
        });
    }

    /* =======================
     * Payload builder
     * ======================= */

    function buildPayload() {
        const areas = [];

        document.querySelectorAll('.area-card').forEach((areaEl, areaIndex) => {
            const areaid = areaEl.dataset.areaid;

            if (!areaid) {
                return; // Ã¡rea virtual
            }

            const subjects = [];
            areaEl.querySelectorAll('.subject-item').forEach((subEl, subIndex) => {
                subjects.push({
                    id: parseInt(subEl.dataset.subjectid, 10),
                    sortorder: subIndex + 1
                });
            });

            areas.push({
                id: parseInt(areaid, 10),
                sortorder: areaIndex + 1,
                subjects: subjects
            });
        });

        return {
            planid: state.planid,
            areas: areas
        };
    }

    function markDirty() {
        state.dirty = true;
    }

    return {
        init: init
    };
});
