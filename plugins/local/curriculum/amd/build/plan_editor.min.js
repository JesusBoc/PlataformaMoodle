define([
    'core/ajax',
    'core/templates',
    'core/toast',
    'core/sortable_list'
], function(Ajax, Templates, Toast, SortableList) {

    let state = null;

    /* ============================================================
     * Public API
     * ============================================================ */

    const init = function(initialState) {
        state = initialState;

        if (!state || state.readonly) {
            return;
        }

        initAreaSorting();
        initSubjectSorting();
        initSaveButton();
        initIhsInputs();
    };

    /* ============================================================
     * Areas sorting (within list)
     * ============================================================ */

    function initAreaSorting() {
        const container = document.querySelector('.plan-areas');

        if (!container) {
            return;
        }

        const sortable = SortableList.create(container, {
            handle: '.area-drag-handle'
        });

        sortable.addEventListener('sortupdate', function() {
            updateAreaOrderFromDOM(container);
            state.dirty = true;
        });
    }

    function updateAreaOrderFromDOM(container) {
        const items = Array.from(container.children);

        const newOrder = [];
        items.forEach(item => {
            const areaId = parseInt(item.dataset.areaId, 10);
            const area = state.areas.find(a => a.id === areaId);
            if (area) {
                newOrder.push(area);
            }
        });

        // Área virtual siempre al final
        state.areas = newOrder.concat(
            state.areas.filter(a => a.is_virtual)
        );
    }

    /* ============================================================
     * Subjects sorting (within each area)
     * ============================================================ */

    function initSubjectSorting() {
        document.querySelectorAll('[data-subjects-sortable]').forEach(list => {

            const sortable = SortableList.create(list, {
                handle: '.subject-drag-handle'
            });

            sortable.addEventListener('sortupdate', function() {
                const areaIndex = parseInt(list.dataset.areaIndex, 10);
                updateSubjectOrderFromDOM(list, areaIndex);
                state.dirty = true;
            });
        });
    }

    function updateSubjectOrderFromDOM(list, areaIndex) {
        const items = Array.from(list.children);
        const area = state.areas[areaIndex];

        const newSubjects = [];
        items.forEach(item => {
            const subjectId = parseInt(item.dataset.subjectId, 10);
            const subject = area.subjects.find(s => s.id === subjectId);
            if (subject) {
                newSubjects.push(subject);
            }
        });

        area.subjects = newSubjects;
    }

    /* ============================================================
     * IHS handling
     * ============================================================ */

    function initIhsInputs() {
        document.querySelectorAll('.ihs-input').forEach(input => {
            input.addEventListener('change', function(e) {
                const subjectId = parseInt(e.target.dataset.subjectId, 10);
                const value = parseInt(e.target.value, 10);

                updateSubjectIhs(subjectId, value);
            });
        });
    }

    function updateSubjectIhs(subjectId, value) {
        state.areas.forEach(area => {
            area.subjects.forEach(subject => {
                if (subject.id === subjectId) {
                    subject.ihs = value;
                    state.dirty = true;
                }
            });
        });
    }

    /* ============================================================
     * Save handling
     * ============================================================ */

    function initSaveButton() {
        const button = document.querySelector('[data-action="save-plan"]');

        if (!button) {
            return;
        }

        button.addEventListener('click', function() {
            if (!state.dirty) {
                return;
            }

            button.disabled = true;

            saveStructure()
                .then(function() {
                    state.dirty = false;
                    showSuccess('Cambios guardados');
                })
                .catch(showError)
                .finally(function() {
                    button.disabled = false;
                });
        });
    }

    function saveStructure() {
        return Ajax.call([{
            methodname: 'local_curriculum_save_plan_structure',
            args: buildSavePayload()
        }])[0];
    }

    /* ============================================================
     * Payload
     * ============================================================ */

    function buildSavePayload() {
        normalizeSortOrders();

        return {
            planid: state.plan.id,
            areas: state.areas
                .filter(area => !area.is_virtual)
                .map(area => ({
                    id: area.id,
                    sortorder: area.sortorder,
                    subjects: area.subjects.map(subject => ({
                        id: subject.id,
                        sortorder: subject.sortorder,
                        ihs: subject.ihs
                    }))
                }))
        };
    }

    function normalizeSortOrders() {
        let areaOrder = 1;

        state.areas.forEach(area => {
            if (area.is_virtual) {
                return;
            }

            area.sortorder = areaOrder++;

            let subjectOrder = 1;
            area.subjects.forEach(subject => {
                subject.sortorder = subjectOrder++;
                subject.areaid = area.id;
            });
        });
    }

    /* ============================================================
     * Toasts
     * ============================================================ */

    function showSuccess(message) {
        Toast.add(message, { type: Toast.TYPE.SUCCESS });
    }

    function showError(error) {
        console.error(error);
        Toast.add(
            'Ocurrió un error al guardar los cambios',
            { type: Toast.TYPE.ERROR }
        );
    }

    return {
        init: init
    };
});