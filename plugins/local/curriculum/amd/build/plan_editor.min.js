define([
    'jquery',
    'core_form/modalform',
    'core/toast',
    'core/ajax',
    'core/notification',
    'core/str'
], function($, ModalForm, Toast, Ajax, Notification, Str) {

    const state = {
        dirty: false
    };

    function moveElement(el, direction) {
        if (el.classList.contains('area-card') && isVirtualArea(el)) {
            return;
        }
        const sibling = direction === 'up'
            ? el.previousElementSibling
            : el.nextElementSibling;

        if (!sibling) {
            return;
        }

        if (
            el.classList.contains('area-card') &&
            direction === 'down' &&
            isVirtualArea(sibling)
        ) {
            return;
        }

        const parent = el.parentElement;

        if (direction === 'up') {
            parent.insertBefore(el, sibling);
        } else {
            parent.insertBefore(sibling, el);
        }

        state.dirty = true;
        updateControls();
    }

    function bindAreaControls() {
        document.querySelectorAll('.move-area-up').forEach(btn => {
            btn.addEventListener('click', e => {
                const area = e.target.closest('.area-card');
                moveElement(area, 'up');
            });
        });

        document.querySelectorAll('.move-area-down').forEach(btn => {
            btn.addEventListener('click', e => {
                const area = e.target.closest('.area-card');
                moveElement(area, 'down');
            });
        });
    }

    function bindSubjectControls() {
        document.querySelectorAll('.move-subject-up').forEach(btn => {
            btn.addEventListener('click', e => {
                const subject = e.target.closest('.subject-item');
                moveElement(subject, 'up');
            });
        });

        document.querySelectorAll('.move-subject-down').forEach(btn => {
            btn.addEventListener('click', e => {
                const subject = e.target.closest('.subject-item');
                moveElement(subject, 'down');
            });
        });
    }

    function collectStructure() {
        const areas = [];

        document.querySelectorAll('.area-card').forEach((areaEl, areaIndex) => {
            const areaid = areaEl.dataset.areaid || null;
            const subjects = [];

            areaEl.querySelectorAll('.subject-item').forEach((subEl, subIndex) => {
                subjects.push({
                    id: subEl.dataset.subjectid,
                    sortorder: subIndex
                });
            });

            areas.push({
                id: areaid,
                sortorder: areaIndex,
                subjects: subjects
            });
        });

        return areas;
    }

    function bindSave(planid) {
        const btn = document.getElementById('save-structure');
        if (!btn) {
            return;
        }

        btn.addEventListener('click', () => {
            const areas = collectStructure();

            Ajax.call([{
                methodname: 'local_curriculum_save_structure',
                args: {
                    planid: planid,
                    areas: areas
                }
            }])[0].then(function() {
                Str.get_string('structuresaved', 'local_curriculum').then(function(msg) {
                    Toast.add(msg, {type: 'success'});
                });
                state.dirty = false;
            }).catch(function(err) {
                Str.get_string('structuresaveerror', 'local_curriculum').then(function(msg) {
                    Toast.add(msg, {type: 'error'});
                });
                console.error(err);
            });
        });
    }

    function isVirtualArea(areaEl) {
        return areaEl.dataset.virtual === '1';
    }

    function updateControls() {
        const areas = Array.from(document.querySelectorAll('.area-card'))
            .filter(a => !isVirtualArea(a));

        areas.forEach((area, index) => {
            const up = area.querySelector('.move-area-up');
            const down = area.querySelector('.move-area-down');

            if (up) up.disabled = index === 0;
            if (down) down.disabled = index === areas.length - 1;
        });

        document.querySelectorAll('.subjects').forEach(list => {
            const items = list.querySelectorAll('.subject-item');

            items.forEach((item, index) => {
                const up = item.querySelector('.move-subject-up');
                const down = item.querySelector('.move-subject-down');

                if (up) up.disabled = index === 0;
                if (down) down.disabled = index === items.length - 1;
            });
        });
    }

    function bindSubjectModal(options) {
        const root = $('.curriculum-plan-editor');

        root.on('click', '.edit-subject, .add-subject', function(e) {
            e.preventDefault();

            const subjectid = $(this).data('subjectid') || 0;
            const areaid = $(this).data('areaid') || 0;
            const planid = root.data('planid');
            
            runAfterSaveIfDirty(planid, function() {
                const titlePromise = subjectid ?
                Str.get_string('editsubject', 'local_curriculum') :
                Str.get_string('createsubject', 'local_curriculum');

                const toastPromise = subjectid ?
                    Str.get_string('subjectupdated', 'local_curriculum') :
                    Str.get_string('subjectcreated', 'local_curriculum');

                Promise.all([titlePromise, toastPromise]).then(function(strings) {
                    const title = strings[0];
                    const toastmsg = strings[1];
                
                    const modal = new ModalForm({
                        formClass: 'local_curriculum\\form\\subject_modal',
                        args: {
                            subjectid: subjectid,
                            planid: planid,
                            areaid: areaid
                        },
                        modalConfig: {
                            title: title
                        }
                    });
                
                    modal.addEventListener(modal.events.FORM_SUBMITTED, function() {
                        Toast.add(toastmsg, {type: 'success'});
                        window.location.reload();
                    });
                
                    modal.show();
                });
            });
        });
    }

    function bindAreaModal(options) {
        const root = $('.curriculum-plan-editor');

        root.on('click', '.edit-area, .add-area', function(e) {
            e.preventDefault();

            const areaid = $(this).data('areaid') || 0;
            const planid = root.data('planid');

            runAfterSaveIfDirty(planid, function() {
                const titlePromise = areaid ?
                Str.get_string('editarea', 'local_curriculum') :
                Str.get_string('createarea', 'local_curriculum');

                const toastPromise = areaid ?
                    Str.get_string('areaupdated', 'local_curriculum') :
                    Str.get_string('areacreated', 'local_curriculum');

                Promise.all([titlePromise, toastPromise]).then(function(strings) {
                    const title = strings[0];
                    const toastmsg = strings[1];
                
                    const modal = new ModalForm({
                        formClass: 'local_curriculum\\form\\area_modal',
                        args: {
                            areaid: areaid,
                            planid: planid
                        },
                        modalConfig: {
                            title: title
                        }
                    });
                
                    modal.addEventListener(modal.events.FORM_SUBMITTED, function() {
                        Toast.add(toastmsg, {type: 'success'});
                        window.location.reload();
                    });
                
                    modal.show();
                });
            });
        });
    }

    function delete_prototype(element){
        const data = {
            'subject': [
                '.delete-subject',
                'subjectid',
                'deletesubjectconfirm',
                'subjectdeleted',
                'subjectdeleteerror',
                'local_curriculum_delete_subject'
            ],
            'area': [
                '.delete-area',
                'areaid',
                'deleteareaconfirm',
                'areadeleted',
                'areadeleteerror',
                'local_curriculum_delete_area'
            ],
        };
        if (!data[element]) {
            console.error('delete_prototype: tipo no soportado', element);
            return;
        }
        const [elementclass,
            elementid,
            confirmstring,
            successstring,
            errorstring,
            methodname
        ] = data[element];

        const root = $('.curriculum-plan-editor');

        root.on('click', elementclass, function(e) {
            e.preventDefault();

            const planid = root.data('planid');
            const id = $(this).data(elementid);

            runAfterSaveIfDirty(planid,function(){
                Str.get_strings([
                {key: 'confirm', component: 'core'},
                {key: confirmstring, component: 'local_curriculum'},
                {key: 'yes', component: 'core'},
                {key: 'no', component: 'core'},
                {key: successstring, component: 'local_curriculum'},
                {key: errorstring, component: 'local_curriculum'}
                ]).then(function(strings) {

                    const title = strings[0];
                    const confirmmsg = strings[1];
                    const yes = strings[2];
                    const no = strings[3];
                    const successmsg = strings[4];
                    const errormsg = strings[5];

                    Notification.confirm(
                        title,
                        confirmmsg,
                        yes,
                        no,
                        function() {
                            Ajax.call([{
                                methodname: methodname,
                                args: {
                                    id: id
                                }
                            }])[0].then(function() {

                                Toast.add(successmsg, {type: 'success'});
                                window.location.reload();

                            }).catch(function() {
                                Toast.add(errormsg, {type: 'error'});
                            });
                        }
                    );
                });
            });
        });
    }

    function delete_subject() {
        delete_prototype('subject');
    }

    function delete_area() {
        delete_prototype('area');
    }

    function runAfterSaveIfDirty(planid, actionFn) {
        if (!state.dirty) {
            return actionFn();
        }

        const areas = collectStructure();
        
        return Ajax.call([{
            methodname: 'local_curriculum_save_structure',
            args: {
                planid: planid,
                areas: areas
            }
        }])[0].then(function() {
            state.dirty = false;
            return actionFn();
        }).catch(function(err) {
            console.error(err);
            return Str.get_string('structuresaveerror', 'local_curriculum').then(function(msg) {
                Toast.add(msg, {type: 'error'});
                throw err;
            });
        });
    }

    return {
        init: function(config) {
            if (config.readonly) {
                return;
            }

            bindAreaControls();
            bindSubjectControls();
            bindSave(config.planid);
            bindSubjectModal(config);
            bindAreaModal(config);
            updateControls();
            delete_subject();
            delete_area();
        }
    };
});
